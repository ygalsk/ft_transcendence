<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸŽ¾ FT_Transcendence Pong Game</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #0f172a;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      background: #1e293b;
      border: 3px solid #38bdf8;
      border-radius: 12px;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #e2e8f0;
      font-family: monospace;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div id="info">Connecting...</div>
  <canvas id="game" width="800" height="500"></canvas>

  <script>
    const JWT = localStorage.getItem("jwt");
    if (!JWT) {
      alert("âš ï¸ You must log in first!");
      window.close();
    }

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const info = document.getElementById("info");

    console.log("ðŸŽŸï¸ JWT before connect:", JWT);
    const socket = io("http://localhost", {
      transports: ["websocket"],
      auth: { token: JWT },
    });
    console.log("ðŸ”Œ Socket.IO connecting to http://localhost/socket.io");
    let side = null;
    let paddleY = 200;
    let opponentY = 200;
    let ball = { x: 400, y: 250 };
    let score = { left: 0, right: 0 };

    const paddleH = 80, paddleW = 10;

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0f172a";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Center line
      ctx.strokeStyle = "#334155";
      ctx.beginPath();
      ctx.setLineDash([10, 10]);
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);

      // Ball
      ctx.fillStyle = "#fbbf24";
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, 8, 0, Math.PI * 2);
      ctx.fill();

      // Paddles
      ctx.fillStyle = "#38bdf8";
      if (side === "left") {
        ctx.fillRect(20, paddleY, paddleW, paddleH);
        ctx.fillRect(canvas.width - 30, opponentY, paddleW, paddleH);
      } else if (side === "right") {
        ctx.fillRect(20, opponentY, paddleW, paddleH);
        ctx.fillRect(canvas.width - 30, paddleY, paddleW, paddleH);
      }

      // Score
      ctx.fillStyle = "#f8fafc";
      ctx.font = "24px monospace";
      ctx.textAlign = "center";
      ctx.fillText(`${score.left} : ${score.right}`, canvas.width / 2, 30);

      requestAnimationFrame(draw);
    }
    draw();

    // --- Socket Events ---
    socket.on("connect", () => info.textContent = "ðŸ•¹ï¸ Connected, waiting for opponent...");
    socket.on("waiting", (m) => info.textContent = m.message);
    socket.on("match_start", (msg) => {
      side = msg.you;
      info.textContent = `ðŸ“ Match started! You are ${side.toUpperCase()}.`;
    });
    socket.on("state", (data) => {
      ball = data.ball;
      score = data.score;
      if (side === "left") opponentY = data.paddles.right;
      else opponentY = data.paddles.left;
    });
    socket.on("match_end", (msg) => info.textContent = `ðŸ Winner: ${msg.winner}`);

    // --- Player Controls ---
    window.addEventListener("keydown", (e) => {
      const step = 15;
      if (side === "left") {
        if (e.key === "w" || e.key === "W") paddleY -= step;
        if (e.key === "s" || e.key === "S") paddleY += step;
      } else if (side === "right") {
        if (e.key === "ArrowUp") paddleY -= step;
        if (e.key === "ArrowDown") paddleY += step;
      }
      paddleY = Math.max(0, Math.min(420, paddleY));
      socket.emit("move", { y: paddleY });
    });
  </script>
</body>
</html>
